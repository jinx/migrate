<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta name="Content-Type" content="text/html; charset=utf-8" />
<title>Module: Jinx::Migratable</title>
<link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="../css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '..';
  if (relpath != '') relpath += '/';
</script>
<script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="../js/app.js"></script>

  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="../_index.html">Index (M)</a> &raquo; 
    <span class='title'><span class='object_link'><a href="../Jinx.html" title="Jinx (module)">Jinx</a></span></span>
     &raquo; 
    <span class="title">Migratable</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  <a id="class_list_link" href="#">Class List</a>
  <a id="method_list_link" href="#">Method List</a>
  <a id ="file_list_link" href="#">File List</a>
</div>

      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Module: Jinx::Migratable
  
  
  
</h1>

<dl class="box">
  
  
    
  
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">lib/jinx/migration/migratable.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>
A Migratable mix-in adds migration support for Resource domain objects. For
each migration Resource created by a Migrator, the migration process is as
follows:
</p>
<ol>
<li><p>
The migrator creates the Resource using the empty constructor.
</p>
</li>
<li><p>
Each input field value which maps to a Resource attribute is obtained from
the migration source.
</p>
</li>
<li><p>
If the Resource class implements a method
<tt>migrate_</tt><em>attribute</em> for the migration <em>attribute</em>,
then that migrate method is called with the input value argument. If there
is a migrate method, then the attribute is set to the result of calling
that method, otherwise the attribute is set to the original input value.
</p>
<p>
For example, if the <tt>Name</tt> input field maps to
<tt>Participant.name</tt>, then a custom <tt>Participant</tt>
<tt>migrate_name</tt> shim method can be defined to reformat the input
name.
</p>
</li>
<li><p>
The Resource attribute is set to the (possibly modified) value.
</p>
</li>
<li><p>
After all input fields are processed, then <span class='object_link'><a href="#migration_valid%3F-instance_method" title="Jinx::Migratable#migration_valid? (method)">Migratable#migration_valid?</a></span> is called to
determine whether the migrated object can be used. <span class='object_link'><a href="#migration_valid%3F-instance_method" title="Jinx::Migratable#migration_valid? (method)">Migratable#migration_valid?</a></span> is
true by default, but a migration shim can add a validation check, migrated
Resource class to return false for special cases.
</p>
<p>
For example, a custom <tt>Participant</tt> <tt>migration_valid?</tt> shim
method can be defined to return whether there is a non-empty input field
value.
</p>
</li>
<li><p>
After the migrated objects are validated, then the Migrator fills in
dependency hierarchy gaps. For example, if the Resource class
<tt>Participant</tt> owns the <tt>enrollments</tt> dependent which in turn
owns the <tt>encounters</tt> dependent and the migration has created a
<tt>Participant</tt> and an <tt>Encounter</tt> but no <tt>Enrollment</tt>,
then an empty <tt>Enrollment</tt> is created which is owned by the migrated
<tt>Participant</tt> and owns the migrated <tt>Encounter</tt>.
</p>
</li>
<li><p>
After all dependencies are filled in, then the independent references are
set for each created Resource (including the new dependents). If a created
Resource has an independent non-collection Resource reference attribute and
there is a migrated instance of that attribute type, then the attribute is
set to that migrated instance.
</p>
<p>
For example, if <tt>Enrollment</tt> has a <tt>study</tt> attribute and
there is a single migrated <tt>Study</tt> instance, then the <tt>study</tt>
attribute is set to that migrated <tt>Study</tt> instance.
</p>
<p>
If the referencing class implements a method
<tt>migrate_</tt><em>attribute</em> for the migration <em>attribute</em>,
then that migrate method is called with the referenced instance argument.
The result is used to set the attribute. Otherwise, the attribute is set to
the original referenced instance.
</p>
<p>
There must be a single unambiguous candidate independent instance, e.g. in
the unlikely but conceivable case that two <tt>Study</tt> instances are
migrated, then the <tt>study</tt> attribute is not set. Similarly,
collection attributes are not set, e.g. a <tt>Study</tt> <tt>protocols</tt>
attribute is not set to a migrated <tt>Protocol</tt> instance.
</p>
</li>
<li><p>
The <span class='object_link'><a href="#migrate-instance_method" title="Jinx::Migratable#migrate (method)">Migratable#migrate</a></span> method is called to complete the migration. As described in
the method documentation, a migration shim Resource subclass can override
the method for custom migration processing, e.g. to migrate the ambiguous
or collection attributes mentioned above, or to fill in missing values.
</p>
<p>
Note that there is an extensive set of attribute defaults defined in the
Metadata application domain classes. These defaults are applied in a
migration database save action and need not be set in a migration shim. For
example, if an acceptable default for a <tt>Study</tt> <tt>active?</tt>
flag is defined in the <tt>Study</tt> meta-data, then the flag does not
need to be set in a migration shim.
</p>
</li>
</ol>


  </div>
</div>
<div class="tags">
  
</div>


  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#extract-instance_method" title="#extract (instance method)">- (Object) <strong>extract</strong>(file) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Extracts the content of this migration target to the given file.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#migrate-instance_method" title="#migrate (instance method)">- (Object) <strong>migrate</strong>(row, migrated) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Completes setting this Migratable domain object&#8217;s attributes from the
given input row.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#migrate_references-instance_method" title="#migrate_references (instance method)">- (Object) <strong>migrate_references</strong>(row, migrated, target, proc_hash = nil) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Migrates this domain object&#8217;s migratable references.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#migration_valid%3F-instance_method" title="#migration_valid? (instance method)">- (Boolean) <strong>migration_valid?</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns whether this migration target domain object is valid.
</p>
</div></span>
  
</li>

      
    </ul>
  



  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="extract-instance_method">
  
    - (<tt>Object</tt>) <strong>extract</strong>(file) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Extracts the content of this migration target to the given file.
</p>
<p>
This base implementation is a no-op. Subclasses can modify this method to
write data to the extract.
</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='type'>(<tt>IO</tt>)</span>
      
      
        <span class='name'>file</span>
      
      
      
        &mdash;
        <div class='inline'><p>
the extract output stream
</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


129
130</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/jinx/migration/migratable.rb', line 129</span>

<span class='def def kw'>def</span> <span class='extract identifier id'>extract</span><span class='lparen token'>(</span><span class='file identifier id'>file</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="migrate-instance_method">
  
    - (<tt>Object</tt>) <strong>migrate</strong>(row, migrated) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Completes setting this Migratable domain object&#8217;s attributes from the
given input row. This method is responsible for migrating attributes which
are not mapped in the configuration. It is called after the configuration
attributes for the given row are migrated and before <span class='object_link'><a href="#migrate_references-instance_method" title="Jinx::Migratable#migrate_references (method)">#migrate_references</a></span>.
</p>
<p>
This base implementation is a no-op. Subclasses can modify this method to
complete the migration. The overridden methods should call <tt>super</tt>
to pick up the superclass migration.
</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='type'>(<tt>{Symbol =&gt; Object}</tt>)</span>
      
      
        <span class='name'>row</span>
      
      
      
        &mdash;
        <div class='inline'><p>
the input row field => value hash
</p>
</div>
      
    </li>
  
    <li>
      
        <span class='type'>(<tt>&lt;Resource&gt;</tt>)</span>
      
      
        <span class='name'>migrated</span>
      
      
      
        &mdash;
        <div class='inline'><p>
the migrated instances, including this domain object
</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


82
83</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/jinx/migration/migratable.rb', line 82</span>

<span class='def def kw'>def</span> <span class='migrate identifier id'>migrate</span><span class='lparen token'>(</span><span class='row identifier id'>row</span><span class='comma token'>,</span> <span class='migrated identifier id'>migrated</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="migrate_references-instance_method">
  
    - (<tt>Object</tt>) <strong>migrate_references</strong>(row, migrated, target, proc_hash = nil) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Migrates this domain object&#8217;s migratable references. This method is
called by the Migrator and should not be overridden by subclasses.
Subclasses tailor individual reference attribute migration by defining a
<tt>migrate_</tt><em>attribute</em> method for the <em>attribute</em> to
modify.
</p>
<p>
The migratable reference attributes consist of the non-collection saved
independent attributes and the unidirectional dependent attributes which
don&#8217;t already have a value. For each such migratable attribute, if
there is a single instance of the attribute type in the given migrated
domain objects, then the attribute is set to that migrated instance.
</p>
<p>
If the attribute is associated with a method in proc_hash, then that method
is called on the migrated instance and input row. The attribute is set to
the method return value. proc_hash includes an entry for each
<tt>migrate_</tt><em>attribute</em> method defined by this Resource&#8217;s
class.
</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='type'>(<tt>{Symbol =&gt; Object}</tt>)</span>
      
      
        <span class='name'>row</span>
      
      
      
        &mdash;
        <div class='inline'><p>
the input row field => value hash
</p>
</div>
      
    </li>
  
    <li>
      
        <span class='type'>(<tt>&lt;Resource&gt;</tt>)</span>
      
      
        <span class='name'>migrated</span>
      
      
      
        &mdash;
        <div class='inline'><p>
the migrated instances, including this Resource
</p>
</div>
      
    </li>
  
    <li>
      
        <span class='type'>(<tt>Class</tt>)</span>
      
      
        <span class='name'>target</span>
      
      
      
        &mdash;
        <div class='inline'><p>
the migration target class
</p>
</div>
      
    </li>
  
    <li>
      
        <span class='type'>(<tt>{Symbol =&gt; Proc}</tt>, <tt>nil</tt>)</span>
      
      
        <span class='name'>proc_hash</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>
a hash that associates this domain object&#8217;s attributes to a migration
shim block
</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


115
116
117
118
119
120
121</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/jinx/migration/migratable.rb', line 115</span>

<span class='def def kw'>def</span> <span class='migrate_references identifier id'>migrate_references</span><span class='lparen token'>(</span><span class='row identifier id'>row</span><span class='comma token'>,</span> <span class='migrated identifier id'>migrated</span><span class='comma token'>,</span> <span class='target identifier id'>target</span><span class='comma token'>,</span> <span class='proc_hash identifier id'>proc_hash</span><span class='assign token'>=</span><span class='nil nil kw'>nil</span><span class='rparen token'>)</span>
  <span class='comment val'># migrate the owner</span>
  <span class='migratable__migrate_owner identifier id'>migratable__migrate_owner</span><span class='lparen token'>(</span><span class='row identifier id'>row</span><span class='comma token'>,</span> <span class='migrated identifier id'>migrated</span><span class='comma token'>,</span> <span class='target identifier id'>target</span><span class='comma token'>,</span> <span class='proc_hash identifier id'>proc_hash</span><span class='rparen token'>)</span>
  <span class='comment val'># migrate the remaining attributes</span>
  <span class='migratable__set_nonowner_references identifier id'>migratable__set_nonowner_references</span><span class='lparen token'>(</span><span class='self self kw'>self</span><span class='dot token'>.</span><span class='class identifier id'>class</span><span class='dot token'>.</span><span class='saved_independent_attributes identifier id'>saved_independent_attributes</span><span class='comma token'>,</span> <span class='row identifier id'>row</span><span class='comma token'>,</span> <span class='migrated identifier id'>migrated</span><span class='comma token'>,</span> <span class='proc_hash identifier id'>proc_hash</span><span class='rparen token'>)</span>
  <span class='migratable__set_nonowner_references identifier id'>migratable__set_nonowner_references</span><span class='lparen token'>(</span><span class='self self kw'>self</span><span class='dot token'>.</span><span class='class identifier id'>class</span><span class='dot token'>.</span><span class='unidirectional_dependent_attributes identifier id'>unidirectional_dependent_attributes</span><span class='comma token'>,</span> <span class='row identifier id'>row</span><span class='comma token'>,</span> <span class='migrated identifier id'>migrated</span><span class='comma token'>,</span> <span class='proc_hash identifier id'>proc_hash</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="migration_valid?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>migration_valid?</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Returns whether this migration target domain object is valid. The default
is true. A migration shim should override this method on the target if
there are conditions which determine whether the migration should be
skipped for this target object.
</p>


  </div>
</div>
<div class="tags">
  <h3>Returns:</h3>
<ul class="return">
  
    <li>
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
      
        &mdash;
        <div class='inline'><p>
whether this migration target domain object is valid
</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


90
91
92</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/jinx/migration/migratable.rb', line 90</span>

<span class='def def kw'>def</span> <span class='migration_valid? fid id'>migration_valid?</span>
  <span class='true true kw'>true</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Thu Feb 16 18:54:02 2012 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.6.1 (ruby-1.8.6).
</div>

  </body>
</html>